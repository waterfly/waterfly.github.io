<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SwiftGG 文档翻译笔记3-泛型可选连错误处理访问控制等 | WaterFly</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="Just Coding">
    
    <link rel="preload" href="/assets/css/0.styles.84748982.css" as="style"><link rel="preload" href="/assets/js/app.3efcfa1f.js" as="script"><link rel="preload" href="/assets/js/3.d41f5393.js" as="script"><link rel="preload" href="/assets/js/1.0d0e82e9.js" as="script"><link rel="preload" href="/assets/js/38.15d6331f.js" as="script"><link rel="prefetch" href="/assets/js/10.6a591f7b.js"><link rel="prefetch" href="/assets/js/11.2da2c136.js"><link rel="prefetch" href="/assets/js/12.597e1e9e.js"><link rel="prefetch" href="/assets/js/13.bfe6e49a.js"><link rel="prefetch" href="/assets/js/14.d5101ebe.js"><link rel="prefetch" href="/assets/js/15.d075eb78.js"><link rel="prefetch" href="/assets/js/16.1de846ec.js"><link rel="prefetch" href="/assets/js/17.73e1206f.js"><link rel="prefetch" href="/assets/js/18.3563029d.js"><link rel="prefetch" href="/assets/js/19.018202b6.js"><link rel="prefetch" href="/assets/js/20.92e231d8.js"><link rel="prefetch" href="/assets/js/21.a26b4bf6.js"><link rel="prefetch" href="/assets/js/22.a240a942.js"><link rel="prefetch" href="/assets/js/23.5d73353d.js"><link rel="prefetch" href="/assets/js/24.1a101222.js"><link rel="prefetch" href="/assets/js/25.f7c05ac5.js"><link rel="prefetch" href="/assets/js/26.cf0f99d3.js"><link rel="prefetch" href="/assets/js/27.4412c990.js"><link rel="prefetch" href="/assets/js/28.a9e9a7e1.js"><link rel="prefetch" href="/assets/js/29.9b39ea41.js"><link rel="prefetch" href="/assets/js/30.19dafc01.js"><link rel="prefetch" href="/assets/js/31.9d2c45f0.js"><link rel="prefetch" href="/assets/js/32.f7aa758f.js"><link rel="prefetch" href="/assets/js/33.54518586.js"><link rel="prefetch" href="/assets/js/34.71ab4ffb.js"><link rel="prefetch" href="/assets/js/35.5442dc08.js"><link rel="prefetch" href="/assets/js/36.3d80fb49.js"><link rel="prefetch" href="/assets/js/37.d767afa3.js"><link rel="prefetch" href="/assets/js/39.a6c25426.js"><link rel="prefetch" href="/assets/js/4.d08f1479.js"><link rel="prefetch" href="/assets/js/40.87d678b9.js"><link rel="prefetch" href="/assets/js/41.edd890b5.js"><link rel="prefetch" href="/assets/js/42.d6677079.js"><link rel="prefetch" href="/assets/js/43.ff4d75ff.js"><link rel="prefetch" href="/assets/js/44.32c7a951.js"><link rel="prefetch" href="/assets/js/45.2c851721.js"><link rel="prefetch" href="/assets/js/46.9bbe5a11.js"><link rel="prefetch" href="/assets/js/47.0e2c36cc.js"><link rel="prefetch" href="/assets/js/48.09bc8442.js"><link rel="prefetch" href="/assets/js/49.52342b74.js"><link rel="prefetch" href="/assets/js/5.9634f48e.js"><link rel="prefetch" href="/assets/js/50.c9e3c4c5.js"><link rel="prefetch" href="/assets/js/51.28a51db9.js"><link rel="prefetch" href="/assets/js/52.58832236.js"><link rel="prefetch" href="/assets/js/53.86af7b76.js"><link rel="prefetch" href="/assets/js/54.973c15bf.js"><link rel="prefetch" href="/assets/js/55.d4a03e12.js"><link rel="prefetch" href="/assets/js/56.ac7e97e0.js"><link rel="prefetch" href="/assets/js/57.7fa14d11.js"><link rel="prefetch" href="/assets/js/58.b0f390b8.js"><link rel="prefetch" href="/assets/js/59.62b96874.js"><link rel="prefetch" href="/assets/js/6.4c543392.js"><link rel="prefetch" href="/assets/js/60.0c40514a.js"><link rel="prefetch" href="/assets/js/61.65259e68.js"><link rel="prefetch" href="/assets/js/62.9fb64114.js"><link rel="prefetch" href="/assets/js/63.3975ffd5.js"><link rel="prefetch" href="/assets/js/64.911d2812.js"><link rel="prefetch" href="/assets/js/65.ce9ab40b.js"><link rel="prefetch" href="/assets/js/66.b89de3df.js"><link rel="prefetch" href="/assets/js/67.4169b86c.js"><link rel="prefetch" href="/assets/js/68.a812ad4b.js"><link rel="prefetch" href="/assets/js/69.b0c76c03.js"><link rel="prefetch" href="/assets/js/7.2aba56aa.js"><link rel="prefetch" href="/assets/js/70.9749f302.js"><link rel="prefetch" href="/assets/js/71.0d38010b.js"><link rel="prefetch" href="/assets/js/72.a6338004.js"><link rel="prefetch" href="/assets/js/73.c1001eb8.js"><link rel="prefetch" href="/assets/js/74.0069037e.js"><link rel="prefetch" href="/assets/js/75.c4591a8d.js"><link rel="prefetch" href="/assets/js/76.e1a3f216.js"><link rel="prefetch" href="/assets/js/77.df0b0aac.js"><link rel="prefetch" href="/assets/js/78.2f535a98.js"><link rel="prefetch" href="/assets/js/79.60e4b9f5.js"><link rel="prefetch" href="/assets/js/8.c5d718a6.js"><link rel="prefetch" href="/assets/js/80.50af71ac.js"><link rel="prefetch" href="/assets/js/81.7d753c90.js"><link rel="prefetch" href="/assets/js/82.5703b0fa.js"><link rel="prefetch" href="/assets/js/83.4af8ebaa.js"><link rel="prefetch" href="/assets/js/84.ed963d52.js"><link rel="prefetch" href="/assets/js/85.7cb175ff.js"><link rel="prefetch" href="/assets/js/86.bd0d1f92.js"><link rel="prefetch" href="/assets/js/87.f00e8426.js"><link rel="prefetch" href="/assets/js/88.a34c0493.js"><link rel="prefetch" href="/assets/js/89.564cb64c.js"><link rel="prefetch" href="/assets/js/9.25143fa3.js"><link rel="prefetch" href="/assets/js/90.ce031d67.js"><link rel="prefetch" href="/assets/js/91.2a75f163.js"><link rel="prefetch" href="/assets/js/92.a2591da3.js"><link rel="prefetch" href="/assets/js/93.6af4f4b0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84748982.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-349e681a><div data-v-349e681a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-b3e6ef50 data-v-349e681a data-v-349e681a><h3 class="title" data-v-b3e6ef50>WaterFly</h3> <p class="description" data-v-b3e6ef50>Just Coding</p> <label id="box" class="inputBox" data-v-b3e6ef50><input type="password" value="" data-v-b3e6ef50> <span data-v-b3e6ef50>Konck! Knock!</span> <button data-v-b3e6ef50>OK</button></label> <div class="footer" data-v-b3e6ef50><span data-v-b3e6ef50><i class="iconfont reco-theme" data-v-b3e6ef50></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-b3e6ef50>vuePress-theme-reco</a></span> <span data-v-b3e6ef50><i class="iconfont reco-copyright" data-v-b3e6ef50></i> <a data-v-b3e6ef50><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-349e681a><header class="navbar" data-v-349e681a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">WaterFly</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link"><i class="undefined"></i>
  算法
</a></div><div class="nav-item"><a href="/Web/" class="nav-link"><i class="undefined"></i>
  Web
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      iOS
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/iOS/Swift/" class="nav-link router-link-active"><i class="undefined"></i>
  Swift
</a></li><li class="dropdown-item"><!----> <a href="/iOS/RN/" class="nav-link"><i class="undefined"></i>
  RN
</a></li><li class="dropdown-item"><!----> <a href="/iOS/OC/" class="nav-link"><i class="undefined"></i>
  OC
</a></li></ul></div></div><div class="nav-item"><a href="/Other/" class="nav-link"><i class="undefined"></i>
  Other
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/waterfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-349e681a></div> <aside class="sidebar" data-v-349e681a><div class="personal-info-wrapper" data-v-1bfe3fa5 data-v-349e681a><img src="/bike.png" alt="author-avatar" class="personal-img" data-v-1bfe3fa5> <!----> <div class="num" data-v-1bfe3fa5><div data-v-1bfe3fa5><h3 data-v-1bfe3fa5>83</h3> <h6 data-v-1bfe3fa5>Articles</h6></div> <div data-v-1bfe3fa5><h3 data-v-1bfe3fa5>34</h3> <h6 data-v-1bfe3fa5>Tags</h6></div></div> <ul class="social-links" data-v-1bfe3fa5></ul> <hr data-v-1bfe3fa5></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link"><i class="undefined"></i>
  算法
</a></div><div class="nav-item"><a href="/Web/" class="nav-link"><i class="undefined"></i>
  Web
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      iOS
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/iOS/Swift/" class="nav-link router-link-active"><i class="undefined"></i>
  Swift
</a></li><li class="dropdown-item"><!----> <a href="/iOS/RN/" class="nav-link"><i class="undefined"></i>
  RN
</a></li><li class="dropdown-item"><!----> <a href="/iOS/OC/" class="nav-link"><i class="undefined"></i>
  OC
</a></li></ul></div></div><div class="nav-item"><a href="/Other/" class="nav-link"><i class="undefined"></i>
  Other
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/waterfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><a href="/iOS/Swift/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/iOS/Swift/SwiftGG/SwiftGG_note_1.html" class="sidebar-link">SwiftGG 文档翻译笔记1-基础部分函数闭包</a></li><li><a href="/iOS/Swift/SwiftGG/SwiftGG_note_2.html" class="sidebar-link">SwiftGG 文档翻译笔记2-FirstClass</a></li><li><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html" aria-current="page" class="active sidebar-link">SwiftGG 文档翻译笔记3-泛型可选连错误处理访问控制等</a></li><li><a href="/iOS/Swift/EquatableHashableComparable.html" class="sidebar-link">Equatable, Hashable, Comparable</a></li><li><a href="/iOS/Swift/String.html" class="sidebar-link">String</a></li><li><a href="/iOS/Swift/SequenceAndCollectionProtocols.html" class="sidebar-link">Sequence and Collection Protocols</a></li><li><a href="/iOS/Swift/Sequence.html" class="sidebar-link">Sequence</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-b3e6ef50 data-v-349e681a><h3 class="title" data-v-b3e6ef50>SwiftGG 文档翻译笔记3-泛型可选连错误处理访问控制等</h3> <!----> <label id="box" class="inputBox" data-v-b3e6ef50><input type="password" value="" data-v-b3e6ef50> <span data-v-b3e6ef50>Konck! Knock!</span> <button data-v-b3e6ef50>OK</button></label> <div class="footer" data-v-b3e6ef50><span data-v-b3e6ef50><i class="iconfont reco-theme" data-v-b3e6ef50></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-b3e6ef50>vuePress-theme-reco</a></span> <span data-v-b3e6ef50><i class="iconfont reco-copyright" data-v-b3e6ef50></i> <a data-v-b3e6ef50><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-349e681a><div data-v-349e681a><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">SwiftGG 文档翻译笔记3-泛型可选连错误处理访问控制等</h1> <div data-v-0b291498><!----> <i class="iconfont reco-date" data-v-0b291498><span data-v-0b291498>8/25/2020</span></i> <!----> <i class="tags iconfont reco-tag" data-v-0b291498><span class="tag-item" data-v-0b291498>Swift</span></i></div></div> <div class="theme-reco-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#泛型">泛型</a></li><li><a href="#可选链">可选链</a></li><li><a href="#错误处理">错误处理</a><ul><li><a href="#与oc的错误处理">与OC的错误处理</a></li></ul></li><li><a href="#defer">defer</a></li><li><a href="#类型转换">类型转换</a></li><li><a href="#不透明类型">不透明类型</a></li><li><a href="#自动引用计数">自动引用计数</a></li><li><a href="#内存安全">内存安全</a><ul><li><a href="#内存安全定义">内存安全定义</a></li><li><a href="#内存冲突发生条件">内存冲突发生条件</a></li><li><a href="#内存访问方式">内存访问方式</a></li><li><a href="#内存冲突的几种场景">内存冲突的几种场景</a><ul><li><a href="#in-out-参数的访问冲突">In-Out 参数的访问冲突</a></li><li><a href="#结构体枚举mutating方法里-self-的访问冲突">结构体枚举mutating方法里 self 的访问冲突</a></li><li><a href="#属性的访问冲突">属性的访问冲突</a></li></ul></li></ul></li><li><a href="#访问控制">访问控制</a><ul><li><a href="#模块和源文件">模块和源文件</a></li><li><a href="#访问级别">访问级别</a></li></ul></li><li><a href="#高级运算符">高级运算符</a><ul><li><a href="#位运算符">位运算符</a></li><li><a href="#溢出运算符">溢出运算符</a></li><li><a href="#运算符函数">运算符函数</a></li></ul></li></ul></div>
[toc]<p></p> <h2 id="泛型"><a href="#泛型" class="header-anchor">#</a> 泛型</h2> <p>泛型是Swift非常强大的特性之一。</p> <p>关键字：<code>&lt; &gt;</code> , <code>associatedtype</code>, <code>where</code></p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/*
	基本格式：&lt;T&gt;声明一个泛型类型T，内部即可使用该类型
	命名规则：大写字母开头，驼峰式；有表示意义时，Dictionary&lt;Key, Value&gt;，Array&lt;Element&gt;，无表示意义时，通常用单个字符，例如 T、U、V
*/</span>

<span class="token comment">//函数泛型</span>
<span class="token keyword">func</span> <span class="token function-definition function">swapTwoValues</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> a<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> b<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> temporaryA <span class="token operator">=</span> a
    a <span class="token operator">=</span> b
    b <span class="token operator">=</span> temporaryA
<span class="token punctuation">}</span>


<span class="token comment">//类型泛型</span>
<span class="token keyword">struct</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token class-name">Element</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Element</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">push</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> item<span class="token punctuation">:</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        items<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> items<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//类型约束，可声明泛型为某类或遵守指定协议</span>
<span class="token keyword">func</span> <span class="token function-definition function">someFunction</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">SomeClass</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token punctuation">:</span> <span class="token class-name">SomeProtocol</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>someT<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> someU<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里是泛型函数的函数体部分</span>
<span class="token punctuation">}</span>
<span class="token comment">//泛型扩展，可在扩展中直接使用已定义的泛型，不需要重新声明</span>
<span class="token keyword">extension</span> <span class="token class-name">Stack</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> topItem<span class="token punctuation">:</span> <span class="token class-name">Element</span><span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> items<span class="token punctuation">.</span>isEmpty <span class="token operator">?</span> <span class="token nil constant">nil</span> <span class="token punctuation">:</span> items<span class="token punctuation">[</span>items<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>




<span class="token comment">/*
	关联类型：关联类型是泛型的一种，用于协议中使用。协议中不能定义泛型，必须用关联类型
	关键字：associatedtype
*/</span>
<span class="token keyword">protocol</span> <span class="token class-name">Container</span> <span class="token punctuation">{</span>
    <span class="token keyword">associatedtype</span> <span class="token class-name">Item</span>		<span class="token comment">//声明一个关联类型</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">append</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> item<span class="token punctuation">:</span> <span class="token class-name">Item</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> count<span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span>
    <span class="token keyword">subscript</span><span class="token punctuation">(</span>i<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//关联类型也可增加约束，指定遵守协议或某类，跟泛型相同</span>
<span class="token comment">//扩展内，也可直接用已定义的关联类型</span>
<span class="token keyword">protocol</span> <span class="token class-name">Container</span> <span class="token punctuation">{</span>
    <span class="token keyword">associatedtype</span> <span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span>		<span class="token comment">//声明关联类型遵守 Equatable 协议</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">append</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> item<span class="token punctuation">:</span> <span class="token class-name">Item</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> count<span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span>
    <span class="token keyword">subscript</span><span class="token punctuation">(</span>i<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>




<span class="token comment">/*
	where语句
	where后可跟多个约束语句，泛型、关联类型支持where语句，可用于函数、类型、扩展、下标等
*/</span>
<span class="token comment">//基本格式</span>
<span class="token keyword">where</span> a <span class="token operator">==</span> b 		<span class="token comment">//限制类型相同</span>
<span class="token keyword">where</span> <span class="token keyword">where</span> <span class="token class-name">Element</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span>		<span class="token comment">//限制遵守协议</span>

<span class="token comment">//限制 C1.Item 与 C2.Item 类型相同，限制 C1.Item 遵守 Equatable 协议，注意where语句位置</span>
<span class="token keyword">func</span> <span class="token function-definition function">allItemsMatch</span><span class="token operator">&lt;</span>C1<span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token punctuation">,</span> C2<span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token operator">&gt;</span>
    <span class="token punctuation">(</span><span class="token omit keyword">_</span> someContainer<span class="token punctuation">:</span> C1<span class="token punctuation">,</span> <span class="token omit keyword">_</span> anotherContainer<span class="token punctuation">:</span> C2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span>
    <span class="token keyword">where</span> C1<span class="token punctuation">.</span><span class="token class-name">Item</span> <span class="token operator">==</span> C2<span class="token punctuation">.</span><span class="token class-name">Item</span><span class="token punctuation">,</span> C1<span class="token punctuation">.</span><span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">//扩展，where语句</span>
<span class="token keyword">extension</span> <span class="token class-name">Container</span> <span class="token keyword">where</span> <span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">startsWith</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> item<span class="token punctuation">:</span> <span class="token class-name">Item</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> count <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> item
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="可选链"><a href="#可选链" class="header-anchor">#</a> 可选链</h2> <p>关键字：<code>?</code> , <code>!</code></p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">//代码示例</span>
<span class="token comment">//定义，如果 john.residence 为 nil，则整个表达式为nil;如果不为nil，则调用  numberOfRooms</span>
john<span class="token punctuation">.</span>residence<span class="token operator">?</span><span class="token punctuation">.</span>numberOfRooms

<span class="token comment">//强制解析写法对比，如果使用强制解析，为nil则直接产生运行时错误</span>
john<span class="token punctuation">.</span>residence<span class="token operator">!</span><span class="token punctuation">.</span>numberOfRooms

<span class="token comment">//通过可选连可调用函数，如果 调用 printNumberOfRooms() 失败，则为nil</span>
<span class="token keyword">if</span> john<span class="token punctuation">.</span>residence<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">printNumberOfRooms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;It was possible to print the number of rooms.&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;It was not possible to print the number of rooms.&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h2> <p>关键字：<code>Error</code>, <code>throws</code> , <code>throw</code>, <code>do-catch</code>, <code>try</code>,  <code>try?</code>, <code>try!</code>，<code>rethrows</code></p> <blockquote><p>Notice: Swift 中的错误处理并不涉及解除调用栈，这是一个计算代价高昂的过程。就此而言，<strong>throw 语句的性能特性是可以和 return 语句相媲美的</strong>。</p></blockquote> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">//关键字解释：</span>
<span class="token class-name">Error</span><span class="token punctuation">:</span>		错误协议，<span class="token keyword">throw</span>抛出的类型必须遵守<span class="token class-name">Error</span>协议，该协议为空协议
<span class="token keyword">throws</span><span class="token punctuation">:</span> 	声明函数为 throwing函数，可以抛出错误
<span class="token keyword">throw</span><span class="token punctuation">:</span>		函数内抛出错误
<span class="token keyword">do</span><span class="token operator">-</span><span class="token keyword">catch</span><span class="token punctuation">:</span> <span class="token class-name">Swift</span>处理错误的一种方式
<span class="token keyword">try</span><span class="token punctuation">:</span> 			用于函数内传递错误
<span class="token keyword">try</span><span class="token operator">?</span><span class="token punctuation">:</span> 		处理错误的一种方式，如果返回是错误，则为<span class="token nil constant">nil</span>
<span class="token keyword">try</span><span class="token operator">!</span><span class="token punctuation">:</span> 		处理错误的一种方式，如果返回错误，则抛出运行时错误
<span class="token keyword">rethrows</span><span class="token punctuation">:</span>	用于在高阶函数中，如果传入非throwing函数，则外部不用处理错误

<span class="token comment">//1. throw使用示例</span>
<span class="token keyword">enum</span> <span class="token class-name">TestSwiftError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> invalidName
    <span class="token keyword">case</span> invaildAge
    <span class="token keyword">case</span> invaildOther
<span class="token punctuation">}</span>


<span class="token comment">//使用 throws 声明该函数为throwing函数，只有 throwing 函数可以传递错误。</span>
<span class="token comment">//任何在某个非 throwing 函数内部抛出的错误只能在函数内部处理。</span>
<span class="token keyword">func</span> <span class="token function-definition function">vend</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token keyword">throws</span><span class="token punctuation">{</span>
    
    <span class="token keyword">guard</span> name <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//使用 throw 抛出Error错误类型</span>
        <span class="token keyword">throw</span> <span class="token class-name">TestSwiftError</span><span class="token punctuation">.</span>invalidName
    <span class="token punctuation">}</span>
    
    <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//2. 处理错误，Swift中有四种处理错误错误方式</span>

<span class="token comment">//2.1 用 throwing 函数传递错误，即把函数抛出的错误传递给调用此函数调用方，使用try</span>
<span class="token keyword">func</span> <span class="token function-definition function">canThrowErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token function">vend</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>     <span class="token comment">//使用try关键字，把vend函数的错误传递给canThrowErrors的调用方处理</span>
<span class="token punctuation">}</span>

<span class="token comment">//2.2 用 do-catch 语句处理错误，使用 do-catch,try</span>
<span class="token comment">//do-catch基本形式</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> expression
    statements
<span class="token punctuation">}</span> <span class="token keyword">catch</span> pattern <span class="token number">1</span> <span class="token punctuation">{</span>
    statements
<span class="token punctuation">}</span> <span class="token keyword">catch</span> pattern <span class="token number">2</span> <span class="token keyword">where</span> condition <span class="token punctuation">{</span>
    statements
<span class="token punctuation">}</span> <span class="token keyword">catch</span> pattern <span class="token number">3</span><span class="token punctuation">,</span> pattern <span class="token number">4</span> <span class="token keyword">where</span> condition <span class="token punctuation">{</span>
    statements
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    statements
<span class="token punctuation">}</span>

<span class="token comment">//do-catch调用示例</span>
<span class="token keyword">func</span> <span class="token function-definition function">testDoCatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token function">canThrowErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token class-name">TestSwiftError</span><span class="token punctuation">.</span>invalidName <span class="token punctuation">{</span>
      	<span class="token comment">//错误类型为 TestSwiftError.invalidName</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;invalidName&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">{</span>
      	<span class="token comment">//如果错误为 TestSwiftError.invalidName 以外的其他错误</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Other&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//2.3 将错误作为可选类型处理，使用 try? 将错误转化为nil</span>
<span class="token keyword">func</span> <span class="token function-definition function">testDoCatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token comment">//当canThrowErrors()抛出错误时，使用try?将错误转化为nil</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token keyword">try</span><span class="token operator">?</span> <span class="token function">canThrowErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//2.4 禁用错误传递，使用 try! 禁用错误回调，当发生错误时，得到运行时错误</span>
<span class="token comment">//使用 try! 是确定不会出现错误回调！但是一旦出现错误，则会得到运行时错误</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token keyword">try</span><span class="token operator">!</span> <span class="token function">canThrowErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



<span class="token comment">//3	rethrows，用于高阶函数中，如果传入非throwing函数，则外部不用处理错误；如果用throws则必须处理错误</span>
<span class="token keyword">extension</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">TestSwift</span> <span class="token punctuation">{</span>
    
    <span class="token comment">//生物验证，throwing函数</span>
    <span class="token keyword">func</span> <span class="token function-definition function">authenticateBiometrically</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> user<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token string-literal"><span class="token string">&quot;Failed&quot;</span></span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//密码验证，非throwing函数</span>
    <span class="token keyword">func</span> <span class="token function-definition function">authenticateByPassword</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> user<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//对外提供统一验证方法，如果用 throws ，则外部调用 authenticateUser 的地方必须处理错误，无论传入的函数是否是 throwing函数</span>
    <span class="token keyword">func</span> <span class="token function-definition function">authenticateUser_throws</span><span class="token punctuation">(</span>method<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;twostraws&quot;</span></span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Success!&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//使用 rethrows，则当传入 非throwing函数时（authenticateByPassword），外部不用处理错误</span>
    <span class="token keyword">func</span> <span class="token function-definition function">authenticateUser_rethrows</span><span class="token punctuation">(</span>method<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span><span class="token punctuation">)</span> <span class="token keyword">rethrows</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;twostraws&quot;</span></span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Success!&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function-definition function">testRethrows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//由于使用了 rethrows ，则这里不用处理错误</span>
        <span class="token function">authenticateUser_rethrows</span><span class="token punctuation">(</span>method<span class="token punctuation">:</span> authenticateByPassword<span class="token punctuation">)</span>
        
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">//由于使用了 throws ，则这里必须处理错误，无论函数是否是throwing函数，否则报错</span>
            <span class="token keyword">try</span> <span class="token function">authenticateUser_throws</span><span class="token punctuation">(</span>method<span class="token punctuation">:</span> authenticateByPassword<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;D'oh!&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>参考：<a href="https://www.hackingwithswift.com/example-code/language/how-to-use-the-rethrows-keyword" target="_blank" rel="noopener noreferrer">How to use the rethrows keyword<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="与oc的错误处理"><a href="#与oc的错误处理" class="header-anchor">#</a> 与OC的错误处理</h3> <p>Swift的错误处理机制类似OC的NSError，Swift和OC的NSError机制可以互相捕捉。</p> <p><strong>但是，OC的Exception，Swift是不能处理的，必须在OC中处理</strong>！</p> <p>具体参考：<a href="https://developer.apple.com/documentation/swift/cocoa_design_patterns/handling_cocoa_errors_in_swift" target="_blank" rel="noopener noreferrer">Handling Cocoa Errors in Swift<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="defer"><a href="#defer" class="header-anchor">#</a> defer</h2> <p>Swift的<code>defer</code>语句很有意思。<code>defer</code> 语句在即将离开当前代码块时执行一系列语句，无论是以何种方式离开当前代码块（抛出错误、return、break等），都会调用调用<code>defer</code>语句。</p> <p><strong><code>defer</code>语句用于进行资源清理和避免重复的返回前需要执行的代码。</strong></p> <p><code>defer</code>语句注意点：</p> <ul><li>defer语句的调用是在 return等语句调用后才调用</li> <li>defer语句内不能再有 return/break/抛出错误等语句</li> <li>如果有多个defer语句，则遵循<strong>先声明后调用</strong>的原则，严格按照顺序，从最后一个声明开始依次调用。</li> <li>defer语句的调用时机是在即将离开<strong>作用域</strong>时调用，<strong>该作用域可能是 闭包、if语句、guard语句、for语句、try语句、函数等</strong></li> <li>defer语句类似闭包，但是不是闭包，不会持有内部的值</li></ul> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">//defer语句基本使用</span>
<span class="token keyword">func</span> <span class="token function-definition function">processFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">exists</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        <span class="token keyword">defer</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> line <span class="token operator">=</span> <span class="token keyword">try</span> file<span class="token punctuation">.</span><span class="token function">readline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理文件。</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// close(file) 会在这里被调用，即作用域的最后。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//注意 闭包、if语句、guard语句、for语句、try语句</span>
<span class="token keyword">func</span> <span class="token function-definition function">remove</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> id<span class="token punctuation">:</span> <span class="token constant">ID</span><span class="token punctuation">,</span> acquireLock<span class="token punctuation">:</span> <span class="token class-name">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> acquireLock <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> <span class="token punctuation">{</span> lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
      
      	<span class="token comment">// defer 语句会在即将退出 if 作用域时调用，而不是函数退出时</span>
    <span class="token punctuation">}</span>
    tasks<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//defer语句调用时机会在 return等条件转义语句后执行</span>
<span class="token keyword">func</span> <span class="token function-definition function">testDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> num <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">func</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token punctuation">{</span> num <span class="token operator">+=</span> <span class="token number">1</span> <span class="token punctuation">}</span>      <span class="token comment">//会在 return 语句后执行</span>
        <span class="token keyword">return</span> num
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;f: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">f</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>        <span class="token comment">//f: 0</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;num: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">num</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>    <span class="token comment">//num: 1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参考：<a href="https://onevcat.com/2018/11/defer/" target="_blank" rel="noopener noreferrer">关于 Swift defer 的正确使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="类型转换"><a href="#类型转换" class="header-anchor">#</a> 类型转换</h2> <p>关键字：<code>is</code> , <code>as</code> , <code>as?</code> , <code>as!</code> , <code>Any</code> , <code>AnyObject</code></p> <p>只用于Class</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">//is, 用于检查类型，与OC isKindOf相同</span>
item <span class="token keyword">is</span> <span class="token class-name">Movie</span>		<span class="token comment">//表达式为 true 或 false</span>

<span class="token comment">//as, 类型转换，有三种使用场景</span>
<span class="token comment">//1. 从派生类转换为基类，向上转型（upcasts）</span>
<span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">:</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> cat <span class="token operator">=</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> animal <span class="token operator">=</span> cat <span class="token keyword">as</span> <span class="token class-name">Animal</span>		<span class="token comment">// animal 类型为  Animal</span>


<span class="token comment">//2. 消除二义性，数值类型转换</span>
<span class="token keyword">let</span> num1 <span class="token operator">=</span> <span class="token number">42</span> <span class="token keyword">as</span> <span class="token class-name">CGFloat</span>
<span class="token keyword">let</span> num2 <span class="token operator">=</span> <span class="token number">42</span> <span class="token keyword">as</span> <span class="token class-name">Int</span>
<span class="token keyword">let</span> num3 <span class="token operator">=</span> <span class="token number">42.5</span> <span class="token keyword">as</span> <span class="token class-name">Int</span>
<span class="token keyword">let</span> num4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">42</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Double</span>


<span class="token comment">//3. switch 语句中进行模式匹配</span>
<span class="token keyword">switch</span> animal <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token keyword">let</span> cat <span class="token keyword">as</span> <span class="token class-name">Cat</span><span class="token punctuation">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;如果是Cat类型对象，则做相应处理&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token keyword">let</span> dog <span class="token keyword">as</span> <span class="token class-name">Dog</span><span class="token punctuation">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;如果是Dog类型对象，则做相应处理&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">break</span>
<span class="token punctuation">}</span>



<span class="token comment">//向下转换（Downcasting），转换到子类型，as!, as?</span>
<span class="token comment">//as!，向下转换，如果失败则触发运行时错误</span>
<span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">:</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> animal <span class="token punctuation">:</span><span class="token class-name">Animal</span>  <span class="token operator">=</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> cat <span class="token operator">=</span> animal <span class="token keyword">as</span><span class="token operator">!</span> <span class="token class-name">Cat</span>

<span class="token comment">//as?, 向下转换，但是转换失败则返回nil，不会触发错误</span>
<span class="token keyword">let</span> animal<span class="token punctuation">:</span><span class="token class-name">Animal</span> <span class="token operator">=</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">let</span> cat <span class="token operator">=</span> animal <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Cat</span><span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;cat is not nil&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;cat is nil&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//Any,AnyObject</span>
<span class="token comment">//Any,可以表示任何类型，包括函数类型</span>
<span class="token comment">//AnyObject,可以表示任何类类型的实例</span>
<span class="token keyword">var</span> things <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">Any</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> things <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">AnyObject</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="不透明类型"><a href="#不透明类型" class="header-anchor">#</a> 不透明类型</h2> <p>关键字：<code>some</code></p> <ul><li><strong>不透明类型与协议或泛型是很像的， 只是在协议或泛型前加some</strong></li> <li>协议或泛型，都可以作为函数返回值，但是如果协议或泛型里包含关联类型或Self，就不能用于比较。Swift的返回值并不是一个指针，所以会对泛型和协议做处理，发生类型擦除，编译器会推断不出来具体类型。</li> <li>不透明类型，不透明类型对应且只能对应一种类型，即不透明类型与某一种类型是绑定的，编译器能推断出类型信息，因此可以用于返回值做相等判断</li> <li>小结，协议或泛型比较灵活，但是作为返回值时会丢失类型信息，因此牵涉到关联类型或Self时，由于丢失了类型信息，编译无法推断出类型，而报错；不透明类型绑定了具体类型，可以理解为编译器记住了类型信息</li> <li>An 'opaque' type must specify only 'Any', 'AnyObject', protocols, and/or a base class</li></ul> <div class="language-swift extra-class"><pre class="language-swift"><code>
<span class="token comment">//协议或泛型，都可以作为函数返回值，但是如果协议或泛型里包含关联类型或Self，就不能用于比较。Swift的返回值并不是一个指针，所以会对泛型和协议做处理，发生类型擦除，编译器会推断不出来具体类型。</span>

<span class="token comment">/*
	协议报错，以下代码会有两个报错
	1. Protocol 'Test' can only be used as a generic constraint because it has Self or associated type requirements
	2. Binary operator '==' cannot be applied to two 'Test' operands
*/</span>
<span class="token keyword">protocol</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">associatedtype</span> <span class="token class-name">Item</span>		<span class="token comment">//关联类型</span>
    <span class="token keyword">func</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">TestStruct</span> <span class="token punctuation">:</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">typealias</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">Int</span>
    <span class="token keyword">func</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Impletemnt Test&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function-definition function">testProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token class-name">TestStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tmp
    
<span class="token punctuation">}</span>

<span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token function">testProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> test_2 <span class="token operator">=</span> <span class="token function">testProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> tmp <span class="token operator">==</span> test_2 <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Equal&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>



<span class="token comment">/*
	泛型报错，以下代码会有1个报错
	1. Binary operator '==' cannot be applied to two 'TestGeneric' operands
*/</span>

<span class="token keyword">struct</span> <span class="token class-name">TestGeneric</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">testGeneric</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> a<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> a
<span class="token punctuation">}</span>

<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token class-name">TestGeneric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">testGeneric</span><span class="token punctuation">(</span><span class="token class-name">TestGeneric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> a <span class="token operator">==</span> b <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;GenericEqual&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">//不透明类型，以下代码正确</span>
<span class="token keyword">protocol</span> <span class="token class-name">Test</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span><span class="token punctuation">{</span>
    <span class="token keyword">associatedtype</span> <span class="token class-name">Item</span>
    <span class="token keyword">func</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">TestStruct</span> <span class="token punctuation">:</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">typealias</span> <span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">Int</span>
    <span class="token keyword">func</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Impletemnt Test&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//声明返回值为 不透明类型，编译器能推断出类型信息</span>
<span class="token keyword">func</span> <span class="token function-definition function">testProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token class-name">TestStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tmp

<span class="token punctuation">}</span>

<span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token function">testProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> test_2 <span class="token operator">=</span> <span class="token function">testProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> tmp <span class="token operator">==</span> test_2 <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Equal&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</code></pre></div><h2 id="自动引用计数"><a href="#自动引用计数" class="header-anchor">#</a> 自动引用计数</h2> <p>关键字：<code>weak</code>、<code>unowned</code></p> <p>Swift也是使用ARC机制来控制内存引用计数，跟OC ARC机制相同，默认引用都是强引用。</p> <p>解决循环引用方法：弱引用（weak） 和 无主引用（unowned）。</p> <ul><li>weak，与OC相同，内存释放后对应指针会自动置为nil，所以变量一定是Optional类型</li> <li>unowed，类似 assign，内存释放后对应指针不会自动置为nil。无主引用通常用于被期望拥有值，即A 无主引用 B，则B初始化赋值后，则应该在A的生命周期内都有值，否则当B释放后，A继续访问B，会引发运行时错误</li></ul> <p>注，如果被捕获的引用绝对不会变为 nil，应该用无主引用，而不是弱引用。</p> <p>三种场景：</p> <ul><li>弱引用，<strong>两个属性值都允许为nil</strong>，并会潜在的产生循环强引用</li> <li>无主引用，<strong>一个允许为 nil，另一个不允许为 nil</strong>，并会潜在的产生循环强引用</li> <li>无主引用 + 隐式解包可选值属性，<strong>两个属性都必须有值，并且初始化完成后永远不会为 nil</strong>。在这种场景中，需要一个类使用无主属性，而另外一个类使用隐式解包可选值属性</li></ul> <div class="language-swift extra-class"><pre class="language-swift"><code>
<span class="token comment">//弱引用 weak，声明弱引用的变量必须是 可选类型</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token punctuation">}</span>
    <span class="token keyword">var</span> apartment<span class="token punctuation">:</span> <span class="token class-name">Apartment</span><span class="token operator">?</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Apartment</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> unit<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>unit<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>unit <span class="token operator">=</span> unit <span class="token punctuation">}</span>
    <span class="token keyword">weak</span> <span class="token keyword">var</span> tenant<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>									<span class="token comment">//声明弱引用，类型必须是可选类型</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Apartment </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">unit</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//无主引用 unowned，无主引用类型</span>
<span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> card<span class="token punctuation">:</span> <span class="token class-name">CreditCard</span><span class="token operator">?</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token punctuation">}</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">CreditCard</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> number<span class="token punctuation">:</span> <span class="token class-name">UInt64</span>
    <span class="token keyword">unowned</span> <span class="token keyword">let</span> customer<span class="token punctuation">:</span> <span class="token class-name">Customer</span>					<span class="token comment">//声明无主引用，该引用要求一定有值</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">UInt64</span><span class="token punctuation">,</span> customer<span class="token punctuation">:</span> <span class="token class-name">Customer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>number <span class="token operator">=</span> number
        <span class="token keyword">self</span><span class="token punctuation">.</span>customer <span class="token operator">=</span> customer
    <span class="token punctuation">}</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Card #</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">number</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
	无主引用和隐式解包可选值属性
*/</span>
<span class="token keyword">class</span> <span class="token class-name">Country</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> capitalCity<span class="token punctuation">:</span> <span class="token class-name">City</span><span class="token operator">!</span>			<span class="token comment">//声明为隐式解包，默认值为nil</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> capitalName<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>capitalCity <span class="token operator">=</span> <span class="token class-name">City</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> capitalName<span class="token punctuation">,</span> country<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">)</span>	<span class="token comment">//由于 capitalCity 默认值为nil，则可以在 init阶段把 self 传入  City</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">City</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">unowned</span> <span class="token keyword">let</span> country<span class="token punctuation">:</span> <span class="token class-name">Country</span>			<span class="token comment">//声明为无主引用，且该值一定有值</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> country<span class="token punctuation">:</span> <span class="token class-name">Country</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>country <span class="token operator">=</span> country
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
	闭包的循环强引用，闭包捕获列表。

	Swift 有如下要求：只要在闭包内使用 self 的成员，就要用 self.someProperty 或者 self.someMethod()（而不只是 someProperty 或 someMethod()）。这提醒你可能会一不小心就捕获了 self。
*/</span>

<span class="token keyword">lazy</span> <span class="token keyword">var</span> someClosure <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">unowned</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">weak</span> delegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>delegate<span class="token punctuation">]</span>		<span class="token comment">//定义闭包捕获列表，声明 self为 无主引用，delegate 为 弱引用</span>
    <span class="token punctuation">(</span>index<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">,</span> stringToProcess<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span> <span class="token keyword">in</span>
    <span class="token comment">// 这里是闭包的函数体</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="内存安全"><a href="#内存安全" class="header-anchor">#</a> 内存安全</h2> <p><strong>注意，这里讨论的内存冲突均是在单线程的条件下，非多线程下的内存安全。</strong></p> <h3 id="内存安全定义"><a href="#内存安全定义" class="header-anchor">#</a> 内存安全定义</h3> <ul><li>默认情况下，Swift 会阻止你代码里不安全的行为。例如，Swift 会保证变量在使用之前就完成初始化，在内存被回收之后就无法被访问，并且数组的索引会做越界检查。</li> <li>Swift 也保证同时访问同一块内存时不会冲突，通过约束代码里对于存储地址的写操作，去获取那一块内存的访问独占权。因为 Swift 自动管理内存，所以大部分时候你完全不需要考虑内存访问的事情</li> <li>内存访问的冲突会发生在你的代码尝试同时访问同一个存储地址的时侯。同一个存储地址的多个访问同时发生会造成不可预计或不一致的行为。</li></ul> <h3 id="内存冲突发生条件"><a href="#内存冲突发生条件" class="header-anchor">#</a> 内存冲突发生条件</h3> <p>以下两个同时发生，则会产生内存冲突</p> <ul><li>至少有一个是写访问</li> <li>它们访问的是同一个存储地址</li> <li>它们的访问在时间线上部分重叠</li></ul> <h3 id="内存访问方式"><a href="#内存访问方式" class="header-anchor">#</a> 内存访问方式</h3> <ul><li>瞬时访问，比如访问某个变量</li> <li>长期访问，会在别的代码执行期间持续进行的内存访问</li></ul> <p><strong>注，当 一个长期访问 与 一个瞬时访问或长期访问 同时发生时，则会产生内存冲突</strong></p> <h3 id="内存冲突的几种场景"><a href="#内存冲突的几种场景" class="header-anchor">#</a> 内存冲突的几种场景</h3> <ul><li>In-Out 参数的访问冲突，<strong>in-out参数在函数内属于长期访问</strong></li> <li>结构体枚举mutating方法里 self 的访问冲突，<strong>mutating方法内对self也是长期访问</strong></li> <li>属性的访问冲突</li></ul> <h4 id="in-out-参数的访问冲突"><a href="#in-out-参数的访问冲突" class="header-anchor">#</a> In-Out 参数的访问冲突</h4> <ul><li><p>一个函数会对它所有的 in-out 参数进行长期写访问。in-out 参数的写访问会在所有非 in-out 参数处理完之后开始，直到函数执行完毕为止。如果有多个 in-out 参数，则写访问开始的顺序与参数的顺序一致。</p></li> <li><p>长期访问的存在会造成一个结果，你不能在访问以 in-out 形式传入后的原变量，即使作用域原则和访问权限允许——任何访问原变量的行为都会造成冲突。</p></li> <li><p>在函数内，In-out参数是内存长期访问形式，从传入开始（参数传入就开始了，不是到函数内才开始），直到函数结束，在这个期间会持续内存访问。所以<strong>在这个期间内，不能再访问对应参数的原始变量，否则就会造成内存冲突</strong></p></li></ul> <h4 id="结构体枚举mutating方法里-self-的访问冲突"><a href="#结构体枚举mutating方法里-self-的访问冲突" class="header-anchor">#</a> 结构体枚举mutating方法里 self 的访问冲突</h4> <p>mutating方法内对Self的访问也是长期访问，也是从函数开始持续到函数结束。<strong>所以如果在函数体内有多个对Self的操作同时发生，也会造成内存冲突</strong></p> <h4 id="属性的访问冲突"><a href="#属性的访问冲突" class="header-anchor">#</a> 属性的访问冲突</h4> <p>如结构体，元组和枚举的类型都是由多个独立的值组成的，例如结构体的属性或元组的元素。因为它们都是值类型，修改值的任何一部分都是对于整个值的修改，意味着其中一个属性的读或写访问都需要访问整一个值。例如，元组元素的写访问重叠会产生冲突。</p> <div class="language-swift extra-class"><pre class="language-swift"><code>

<span class="token comment">//In-Out 参数的访问冲突，该代码会在运行时报错</span>
<span class="token keyword">var</span> stepSize <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">func</span> <span class="token function-definition function">increment</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> number<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    number <span class="token operator">+=</span> stepSize
<span class="token punctuation">}</span>

<span class="token function">increment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stepSize<span class="token punctuation">)</span>



<span class="token comment">//结构体枚举mutating方法里 self 的访问冲突</span>
<span class="token keyword">func</span> <span class="token function-definition function">balance</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> x<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Int</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> y<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> x <span class="token operator">+</span> y
    x <span class="token operator">=</span> sum <span class="token operator">/</span> <span class="token number">2</span>
    y <span class="token operator">=</span> sum <span class="token operator">-</span> x
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">Player</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> health<span class="token punctuation">:</span> <span class="token class-name">Int</span>
    <span class="token keyword">var</span> energy<span class="token punctuation">:</span> <span class="token class-name">Int</span>

    <span class="token keyword">static</span> <span class="token keyword">let</span> maxHealth <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">restoreHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">=</span> <span class="token class-name">Player</span><span class="token punctuation">.</span>maxHealth
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token class-name">Player</span> <span class="token punctuation">{</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">shareHealth</span><span class="token punctuation">(</span>with teammate<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Player</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">balance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>teammate<span class="token punctuation">.</span>health<span class="token punctuation">,</span> <span class="token operator">&amp;</span>health<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> oscar <span class="token operator">=</span> <span class="token class-name">Player</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Oscar&quot;</span></span><span class="token punctuation">,</span> health<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> energy<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> maria <span class="token operator">=</span> <span class="token class-name">Player</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Maria&quot;</span></span><span class="token punctuation">,</span> health<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> energy<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
oscar<span class="token punctuation">.</span><span class="token function">shareHealth</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> <span class="token operator">&amp;</span>oscar<span class="token punctuation">)</span>  <span class="token comment">// 错误：oscar 访问冲突</span>




<span class="token comment">//属性的访问冲突</span>
<span class="token keyword">func</span> <span class="token function-definition function">balance</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> x<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Int</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> y<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> x <span class="token operator">+</span> y
    x <span class="token operator">=</span> sum <span class="token operator">/</span> <span class="token number">2</span>
    y <span class="token operator">=</span> sum <span class="token operator">-</span> x
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">Player</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> health<span class="token punctuation">:</span> <span class="token class-name">Int</span>
    <span class="token keyword">var</span> energy<span class="token punctuation">:</span> <span class="token class-name">Int</span>

    <span class="token keyword">static</span> <span class="token keyword">let</span> maxHealth <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">restoreHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        health <span class="token operator">=</span> <span class="token class-name">Player</span><span class="token punctuation">.</span>maxHealth
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> playerInformation <span class="token operator">=</span> <span class="token punctuation">(</span>health<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> energy<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token function">balance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>playerInformation<span class="token punctuation">.</span>health<span class="token punctuation">,</span> <span class="token operator">&amp;</span>playerInformation<span class="token punctuation">.</span>energy<span class="token punctuation">)</span>	<span class="token comment">// 错误：playerInformation 的属性访问冲突，这里 playerInformation.health 需要对 playerInformation 发起写访问；而 playerInformation.energy 也会对 playerInformation 发起写访问，两个写访问重叠了</span>



</code></pre></div><h2 id="访问控制"><a href="#访问控制" class="header-anchor">#</a> 访问控制</h2> <h3 id="模块和源文件"><a href="#模块和源文件" class="header-anchor">#</a> 模块和源文件</h3> <p>Swift的访问控制是基于 模块和源文件 的角度定义</p> <ul><li>模块，模块可以理解为一个框架，比如Framework</li> <li>源文件即代码文件</li></ul> <h3 id="访问级别"><a href="#访问级别" class="header-anchor">#</a> 访问级别</h3> <table><thead><tr><th>级别依次降低</th> <th></th></tr></thead> <tbody><tr><td>open</td> <td>让实体被同一模块内所有文件访问，在模块外也可以导入该模块对应实体进行访问，与public类似，但open只能作用于类和类的成员，且限定的类和成员能够被模块外被继承和重写</td></tr> <tr><td>public</td> <td>public类型的所有成员访问级别仍然是默认 internal。所以如果对某个成员开放，需要单独指定 public</td></tr> <tr><td>internal</td> <td>限定实体在同一模块内访问，为默认访问级别</td></tr> <tr><td>fileprivate</td> <td>限定实体只能在文件内访问</td></tr> <tr><td>private</td> <td>限定在作用域和同一文件的extension</td></tr></tbody></table> <p>访问级别基本原则，实体不能定义在具有更低访问级别（更严格）的实体中。</p> <p><img src="/assets/img/AccessControl.fbeb6191.jpg" alt=""></p> <h2 id="高级运算符"><a href="#高级运算符" class="header-anchor">#</a> 高级运算符</h2> <h3 id="位运算符"><a href="#位运算符" class="header-anchor">#</a> 位运算符</h3> <ul><li>Bitwise NOT Operator（按位取反运算符），~</li> <li>Bitwise AND Operator（按位与运算符），&amp;</li> <li>Bitwise OR Operator（按位或运算符），|</li> <li>Bitwise XOR Operator（按位异或运算符），^</li> <li>Bitwise Left and Right Shift Operators（按位左移、右移运算符），&lt;&lt;, &gt;&gt;</li></ul> <h3 id="溢出运算符"><a href="#溢出运算符" class="header-anchor">#</a> 溢出运算符</h3> <ul><li>溢出加法 &amp;+</li> <li>溢出减法 &amp;-</li> <li>溢出乘法 &amp;*</li></ul> <h3 id="运算符函数"><a href="#运算符函数" class="header-anchor">#</a> 运算符函数</h3> <ul><li>运算符重载，类和结构体可以为现有的运算符提供自定义的实现</li> <li>前缀和后缀运算符，关键字 <code>prefix</code></li> <li>自定义运算符，除了实现标准运算符，在 Swift 中还可以声明和实现自定义运算符。可以用来自定义运算符的字符列表请参考 运算符。新的运算符要使用 operator 关键字在全局作用域内进行定义，同时还要指定 prefix、infix 或者 postfix 修饰符</li> <li>自定义中缀运算符的优先级</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/5/2020, 4:47:28 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/iOS/Swift/SwiftGG/SwiftGG_note_2.html" class="prev">
          SwiftGG 文档翻译笔记2-FirstClass
        </a></span> <span class="next"><a href="/iOS/Swift/EquatableHashableComparable.html">
          Equatable, Hashable, Comparable
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-3b069fde data-v-349e681a><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#泛型" class="sidebar-link reco-side-泛型" data-v-3b069fde>泛型</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#可选链" class="sidebar-link reco-side-可选链" data-v-3b069fde>可选链</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#错误处理" class="sidebar-link reco-side-错误处理" data-v-3b069fde>错误处理</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#与oc的错误处理" class="sidebar-link reco-side-与oc的错误处理" data-v-3b069fde>与OC的错误处理</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#defer" class="sidebar-link reco-side-defer" data-v-3b069fde>defer</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#类型转换" class="sidebar-link reco-side-类型转换" data-v-3b069fde>类型转换</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#不透明类型" class="sidebar-link reco-side-不透明类型" data-v-3b069fde>不透明类型</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#自动引用计数" class="sidebar-link reco-side-自动引用计数" data-v-3b069fde>自动引用计数</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#内存安全" class="sidebar-link reco-side-内存安全" data-v-3b069fde>内存安全</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#内存安全定义" class="sidebar-link reco-side-内存安全定义" data-v-3b069fde>内存安全定义</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#内存冲突发生条件" class="sidebar-link reco-side-内存冲突发生条件" data-v-3b069fde>内存冲突发生条件</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#内存访问方式" class="sidebar-link reco-side-内存访问方式" data-v-3b069fde>内存访问方式</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#内存冲突的几种场景" class="sidebar-link reco-side-内存冲突的几种场景" data-v-3b069fde>内存冲突的几种场景</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#访问控制" class="sidebar-link reco-side-访问控制" data-v-3b069fde>访问控制</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#模块和源文件" class="sidebar-link reco-side-模块和源文件" data-v-3b069fde>模块和源文件</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#访问级别" class="sidebar-link reco-side-访问级别" data-v-3b069fde>访问级别</a></li><li class="level-2" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#高级运算符" class="sidebar-link reco-side-高级运算符" data-v-3b069fde>高级运算符</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#位运算符" class="sidebar-link reco-side-位运算符" data-v-3b069fde>位运算符</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#溢出运算符" class="sidebar-link reco-side-溢出运算符" data-v-3b069fde>溢出运算符</a></li><li class="level-3" data-v-3b069fde><a href="/iOS/Swift/SwiftGG/SwiftGG_note_3.html#运算符函数" class="sidebar-link reco-side-运算符函数" data-v-3b069fde>运算符函数</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-2a01419c data-v-2a01419c><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-2a01419c><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-2a01419c></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-2a01419c></path></svg></div></div></div>
    <script src="/assets/js/app.3efcfa1f.js" defer></script><script src="/assets/js/3.d41f5393.js" defer></script><script src="/assets/js/1.0d0e82e9.js" defer></script><script src="/assets/js/38.15d6331f.js" defer></script>
  </body>
</html>
